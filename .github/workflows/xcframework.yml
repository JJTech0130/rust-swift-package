name: Generate XCFramework

on:
  push:
    branches: [ "master" ]

jobs:
  build:
    runs-on: macos-latest
    if: ${{ false }}  # disable for now
    steps:
    - uses: actions/checkout@v3
    
    - name: Add aarch64-apple-ios target
      run: rustup target add aarch64-apple-ios
    - name: Add x86_64-apple-ios target
      run: rustup target add x86_64-apple-ios
       
    - name: Generate XCFramework
      run: make xcframework
      
    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: xcframework
        path: target/*.xcframework/
        
    - name: Dispatch workflow in Swift package repository
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.SWIFT_PACKAGE_TOKEN }}
        script: |
          await github.rest.actions.createWorkflowDispatch({
            owner: '${{ secrets.SWIFT_PACKAGE_OWNER }}',
            repo: '${{ secrets.SWIFT_PACKAGE_REPO }}',
            workflow_id: 'main.yml',
            ref: 'master',
            inputs: {
              url: 'https://nightly.link/JJTech0130/xcframework-template/actions/runs/${{ github.run_id }}/xcframework.zip'
            }
          })
          
  deploy:
    runs-on: ubuntu-latest
  
    steps:
    - name: extract current branch
      #shell: bash
      #run: echo "##[set-output name=branch;]$(echo ${GITHUB_REF#refs/heads/})"
      run: echo "::set-output name=branch::${GITHUB_REF#refs/heads/}"
      id: extract_branch
    
    - name: check if output branch exists
      run: |
        
    - name: switch to output branch
      run: |
        echo "swift/${{ steps.extract_branch.outputs.branch }}"
      #echo "::set-output name=action_fruit::strawberry"

    #- name: check for branch
    #  env:
    #    branch: 
    #  run: |
    #    git show-ref --verify --quiet refs/heads/<branch-name>
    #    ret=$?
    #    if [ $ret -ne 0 ]; then
    #      echo "
    #    else
    #      echo "In Else"
    ##   fi
